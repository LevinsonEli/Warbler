const { parse } = require('url');
const { request } = require('https');
const { globalAgent } = require('http');

function send(method, uri, opts={}) {
	return new Promise((res, rej) => {
		let out = '';
		let headers = opts.headers || {};
		let { protocol, hostname, port, path } = parse(uri);
		let o = { protocol, path, method, hostname, port, headers };
		if (protocol === 'http:') o.agent = globalAgent;

		let req = request(o, r => {
			r.setEncoding('utf8');

			r.on('data', d => {
				out += d;
			});

			r.on('end', () => {
				let type = r.headers['content-type'];
				if (type && type.includes('application/json')) {
					out = JSON.parse(out);
				}
				r.data = out;
				(r.statusCode >= 400 ? rej : res)(r);
			});
		});

		req.on('error', rej);

		if (opts.body) {
			let isObj = typeof opts.body === 'object';
			let str = isObj ? JSON.stringify(opts.body) : opts.body;
			isObj && req.setHeader('content-type', 'application/json');
			req.setHeader('content-length', Buffer.byteLength(str));
			req.write(str);
		}

		req.end();
	});
}

exports.get = send.bind(null, 'GET');
exports.post = send.bind(null, 'POST');
exports.patch = send.bind(null, 'PATCH');
exports.del = send.bind(null, 'DELETE');
exports.put = send.bind(null, 'PUT');

exports.send = send;
